{% extends "base.html" %}

{% block title %}{{ plant.name }} â€” Plant Details{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <!-- Left: Plant card -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm">
                {% if plant.photo_filename %}
                <img src="{{ url_for('static', filename='uploads/' + plant.photo_filename) }}" class="card-img-top"
                    alt="{{ plant.name }}">
                {% else %}
                <div class="card-img-top d-flex align-items-center justify-content-center"
                    style="height:220px; background:#f8f9fa;">
                    <i class="bi bi-tree fs-1 text-muted"></i>
                </div>
                {% endif %}

                <div class="card-body">
                    <h4 class="card-title mb-1">{{ plant.name }}</h4>
                    <p class="mb-1 text-muted small">{{ plant.species }}</p>
                    <p class="mb-2"><i class="bi bi-geo-alt me-1"></i>{{ plant.location }}</p>

                    <p class="mb-1">
                        <strong>Watering every:</strong> {{ plant.watering_frequency }} day(s)
                    </p>
                    <p class="mb-2">
                        <strong>Sunlight:</strong>
                        {% if plant.sunlight_preference == "full_sun" %}Full Sun{% elif plant.sunlight_preference ==
                        "partial_shade" %}Partial Shade{% else %}Full Shade{% endif %}
                    </p>

                    <p class="mb-0 text-muted small">
                        {% if plant.local_last_watered %}
                        <i class="bi bi-droplet-fill"></i> Last watered:
                        {{ plant.local_last_watered.strftime("%Y-%m-%d %I:%M %p") }}
                        {% else %}
                        <i class="bi bi-droplet"></i> Not watered yet
                        {% endif %}
                    </p>

                    <div class="mt-3 d-flex gap-2">
                        <a href="{{ url_for('edit_plant', id=plant.id) }}"
                            class="btn btn-outline-primary btn-sm">Edit</a>

                        <form method="POST" action="{{ url_for('delete_plant', id=plant.id) }}" class="d-inline">
                            {{ delete_form.hidden_tag() }}
                            {{ delete_form.submit(class="btn btn-outline-danger btn-sm", value="Delete Plant") }}
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Care events + Add event form + Journal -->
        <div class="col-lg-8">
            <div class="row">
                <!-- Add Care Event -->
                <div class="col-md-6 mb-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-body">
                            <h5 class="card-title">Add Care Event</h5>
                            <form method="POST" action="{{ url_for('add_care_event', id=plant.id) }}">
                                {{ care_form.hidden_tag() }}

                                <div class="mb-3">
                                    {{ care_form.event_type.label(class="form-label") }}
                                    {{ care_form.event_type(class="form-select" + (" is-invalid" if
                                    care_form.event_type.errors else "")) }}
                                    {% if care_form.event_type.errors %}
                                    <div class="invalid-feedback">
                                        {{ care_form.event_type.errors[0] }}
                                    </div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    {{ care_form.notes.label(class="form-label") }}
                                    {{ care_form.notes(class="form-control", rows="3", placeholder="Optional notes...")
                                    }}
                                </div>

                                <div>
                                    {{ care_form.submit(class="btn btn-success") }}
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Care Events List -->
                <div class="col-md-6 mb-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-body">
                            <h5 class="card-title">Care Events</h5>

                            {% if care_events %}
                            <ul class="list-group list-group-flush">
                                {% for event in care_events %}
                                <li class="list-group-item d-flex justify-content-between align-items-start">
                                    <div>
                                        <div class="fw-semibold">
                                            {% if event.event_type == "watering" %}Watering{% elif event.event_type ==
                                            "fertilizing" %}Fertilizing{% elif event.event_type == "pruning" %}Pruning{%
                                            else %}Repotting{% endif %}
                                        </div>
                                        <div class="small text-muted">
                                            {% if event.local_time %}
                                            {{ event.local_time.strftime("%Y-%m-%d %I:%M %p") }}
                                            {% else %}
                                            {{ event.event_date.strftime("%Y-%m-%d %I:%M %p") }}
                                            {% endif %}
                                        </div>
                                        {% if event.notes %}
                                        <div class="mt-1">{{ event.notes }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="ms-3">
                                        <form method="POST"
                                            action="{{ url_for('delete_care_event', event_id=event.id) }}">
                                            {{ delete_form.hidden_tag() }}
                                            {{ delete_form.submit(class="btn btn-sm btn-outline-danger", value="Delete")
                                            }}
                                        </form>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <p class="text-muted small mb-0">No care events yet.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Journal Timeline -->
                <div class="col-12 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title mb-0">Journal Timeline</h5>
                                <a href="{{ url_for('add_journal_entry', id=plant.id) }}"
                                    class="btn btn-sm btn-outline-secondary">Add entry</a>
                            </div>

                            {% if journal_entries %}
                            <div class="timeline">
                                {% for entry in journal_entries %}
                                <div class="timeline-item">
                                    <div class="timeline-content card shadow-sm p-3">
                                        {% if entry.photo_filename %}
                                        <img src="{{ url_for('static', filename='uploads/' + entry.photo_filename) }}"
                                            alt="Journal Image" class="rounded shadow-sm mb-2"
                                            style="max-width: 230px; border-radius: 12px;">
                                        {% else %}
                                        <div class="text-muted small fst-italic">No image uploaded</div>
                                        {% endif %}

                                        {% if entry.content %}
                                        <p class="mt-2 mb-0">{{ entry.content }}</p>
                                        {% endif %}

                                        <div class="d-flex justify-content-between align-items-center mt-2">
                                            <div class="small text-muted">
                                                {% if entry.local_time %}
                                                {{ entry.local_time.strftime("%Y-%m-%d %I:%M %p") }}
                                                {% else %}
                                                {{ entry.entry_date.strftime("%Y-%m-%d %I:%M %p") }}
                                                {% endif %}
                                            </div>
                                            <form method="POST"
                                                action="{{ url_for('delete_journal_entry', entry_id=entry.id) }}">
                                                {{ delete_form.hidden_tag() }}
                                                {{ delete_form.submit(class="btn btn-sm btn-outline-danger",
                                                value="Delete") }}
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <p class="text-muted small mb-0">No journal entries yet.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>


            </div>
        </div>
    </div>
</div>
{% endblock %}